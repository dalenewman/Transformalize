<?xml version="1.0" encoding="utf-8"?>
<transformalize>

  <environments default="test" >
    <add name="prod" >
      <parameters>
        <add name="SqlServer" value="127.0.0.1" />
      </parameters>
    </add>
    <add name="test" >
      <parameters>
        <add name="SqlServer" value="localhost" />
      </parameters>
    </add>
  </environments>

  <processes>
   
    <add name="NorthWind" enabled="true">

      <log rows="1000">
        <add name="console" provider="console" level="info" layout="${date:format=HH\:mm\:ss} | ${message}"/>
        <add name="file" provider="file" level="info" file="${basedir}/logs/NorthWind-Tfl-${date:format=yyyy-MM-dd}.log" layout="${date:format=HH\:mm\:ss} | ${message}" />
      </log>

      <file-inspection>
        <add name="default">
          <types>
            <add type="decimal"/>
            <add type="string"/>
          </types>
          <delimiters>
            <add name="comma" character=","/>
            <add name="pipe" character="|"/>
            <add name="tab" character="&#009;"/>
            <add name="semicolon" character=";"/>
          </delimiters>
        </add>
      </file-inspection>

      <connections>
        <add name="input" connection-string="Server=@(SqlServer);Database=NorthWind;Trusted_Connection=True;" />
        <add name="output" database="NorthWindStar" port="1433" />
        <add name="ssas" database="NorthWind" provider="analysisservices" />
      </connections>
      
      <templates path="Templates">

        <add name="solr-data-handler" file="solr-data-handler.cshtml" cache="true">
          <actions>
            <add action="copy" file="C:\Solr\NorthWind\conf\data-config.xml" />
          </actions>
        </add>

        <add name="solr-schema" file="solr-schema.cshtml" cache="true">
          <actions>
            <add action="copy" file="C:\Solr\NorthWind\conf\schema.xml"/>
            <add action="web" mode="init" url="http://localhost:8983/solr/admin/cores?action=RELOAD&amp;core=NorthWind"/>
            <add action="web" mode="first" url="http://localhost:8983/solr/NorthWind/dataimport?command=full-import&amp;clean=true&amp;commit=true&amp;optimize=true"/>
            <add action="web" mode="default" url="http://localhost:8983/solr/NorthWind/dataimport?command=delta-import&amp;clean=false&amp;commit=true&amp;optimize=true"/>
          </actions>
        </add>
      </templates>

      <search-types>
        <add name="default" />
        <add name="none" store="false" index="false" />
        <add name="facet" analyzer="lowercase" store="true" index="true" />
        <add name="standard" analyzer="standard_lowercase" store="false" index="true"/>
      </search-types>

      <entities>

        <add name="Order Details" version="RowVersion" prefix="OrderDetails">
          <fields>
            <add name="Discount" type="single" ></add>
            <add name="OrderID" type="int" primary-key="true"></add>
            <add name="ProductID" type="int" primary-key="true"></add>
            <add name="Quantity" type="int16" ></add>
            <add name="RowVersion" type="rowversion" length="8" search-type="none"/>
            <add name="UnitPrice" type="decimal" precision="19" scale="4"/>
          </fields>
          <calculated-fields>
            <add name="OrderDetailsExtendedPrice" type="decimal" precision="19" scale="4">
              <transforms>
                <add method="javascript" script="OrderDetailsQuantity * (OrderDetailsUnitPrice * (1-OrderDetailsDiscount))" parameter="*" />
              </transforms>
            </add>
          </calculated-fields>
        </add>

        <add name="Orders" version="RowVersion" prefix="Orders">
          <fields>
            <add name="CustomerID" type="char" length="5"/>
            <add name="EmployeeID" type="int"/>
            <add name="Freight" type="decimal" precision="19" scale="4"/>
            <add name="OrderDate" type="datetime"/>
            <add name="OrderID" type="int" primary-key="true"></add>
            <add name="RequiredDate" type="datetime" ></add>
            <add name="RowVersion" type="rowversion" length="8" search-type="none"/>
            <add name="ShipAddress" length="60" ></add>
            <add name="ShipCity" length="15" ></add>
            <add name="ShipCountry" length="15" ></add>
            <add name="ShipName" length="40" ></add>
            <add name="ShippedDate" type="datetime" ></add>
            <add name="ShipPostalCode" length="10" ></add>
            <add name="ShipRegion" length="15" ></add>
            <add name="ShipVia" type="int" ></add>
          </fields>

          <calculated-fields>
            <add name="TimeOrderMonth" length="6" default="12-DEC">
              <transforms>
                <add method="tostring" format="MM-MMM" parameter="OrderDate" />
                <add method="toUpper" />
              </transforms>
            </add>
            <add name="TimeOrderDate" length="10" default="9999-12-31">
              <transforms>
                <add method="tostring" format="yyyy-MM-dd" parameter="OrderDate" />
              </transforms>
            </add>
            <add name="TimeOrderYear" length="4" default="9999">
              <transforms>
                <add method="tostring" format="yyyy" parameter="OrderDate" />
              </transforms>
            </add>
          </calculated-fields>
        </add>

        <add name="Customers" version="RowVersion" prefix="Customers">
          <fields>
            <add name="Address" length="60" ></add>
            <add name="City" length="15" ></add>
            <add name="CompanyName" length="40" >
              <transforms>
                <add method="domain" domain="Wartian Herkku,Die Wandernde Kuh" result-field="x">
                  <branches>
                    <add name="pass" run-field="x" run-value="true">
                      <transforms>
                        <add method="toUpper"/>
                      </transforms>
                    </add>
                    <add name="fail" run-field="x" run-value="false">
                      <transforms>
                        <add method="toLower"/>
                      </transforms>
                    </add>
                  </branches>
                </add>
              </transforms>
            </add>
            <add name="ContactName" length="30" ></add>
            <add name="ContactTitle" length="30" ></add>
            <add name="Country" length="15" ></add>
            <add name="CustomerID" type="char" length="5" primary-key="true"></add>
            <add name="Fax" length="24" ></add>
            <add name="Phone" length="24" ></add>
            <add name="PostalCode" length="10" ></add>
            <add name="Region" length="15" ></add>
            <add name="RowVersion" type="byte[]" length="8" ></add>
          </fields>
        </add>

        <add name="Employees" version="RowVersion" prefix="Employees">
          <fields>
            <add name="Address" length="60" ></add>
            <add name="BirthDate" type="datetime" ></add>
            <add name="City" length="15" ></add>
            <add name="Country" length="15" ></add>
            <add name="EmployeeID" type="int" primary-key="true"></add>
            <add name="Extension" length="4" ></add>
            <add name="FirstName" length="10" ></add>
            <add name="HireDate" type="datetime" ></add>
            <add name="HomePhone" length="24" ></add>
            <add name="LastName" length="20" ></add>
            <add name="Notes" length="MAX" ></add>
            <add name="Photo" alias="EmployeesPhoto" input="false" output="false"></add>
            <add name="PhotoPath" alias="EmployeesPhotoPath" input="false" output="false"></add>
            <add name="PostalCode" length="10" ></add>
            <add name="Region" length="15" ></add>
            <add name="RowVersion" type="byte[]" length="8" ></add>
            <add name="Title" length="30" ></add>
            <add name="TitleOfCourtesy" length="25" ></add>
            <add name="ReportsTo" alias="EmployeesManager" type="string" length="64">
              <transforms>
                <add method="map" map="Managers"></add>
              </transforms>
            </add>
          </fields>
          <calculated-fields>
            <add name="Employee">
              <transforms>
                <add method="join" separator=" ">
                  <parameters>
                    <add field="FirstName"></add>
                    <add field="LastName"></add>
                  </parameters>
                </add>
              </transforms>
            </add>
          </calculated-fields>
        </add>

        <add name="Products" version="RowVersion" prefix="Products">
          <fields>
            <add name="CategoryID" type="int32"/>
            <add name="Discontinued" type="boolean"/>
            <add name="ProductID" type="int" primary-key="true"/>
            <add name="ProductName" length="40"/>
            <add name="QuantityPerUnit" length="20"/>
            <add name="ReorderLevel" type="int16"/>
            <add name="RowVersion" type="rowversion" length="8" search-type="none"/>
            <add name="SupplierID" type="int"/>
            <add name="UnitPrice" type="decimal" precision="19" scale="4"/>
            <add name="UnitsInStock" type="int16"/>
            <add name="UnitsOnOrder" type="int16"/>
          </fields>
        </add>

        <add name="Suppliers" version="RowVersion" prefix="Suppliers">
          <fields>
            <add name="Address" length="60" ></add>
            <add name="City" length="15" ></add>
            <add name="CompanyName" length="40" ></add>
            <add name="ContactName" length="30" ></add>
            <add name="ContactTitle" length="30" ></add>
            <add name="Country" length="15" ></add>
            <add name="Fax" length="24" ></add>
            <add name="HomePage" length="MAX" ></add>
            <add name="Phone" length="24" ></add>
            <add name="PostalCode" length="10" ></add>
            <add name="Region" length="15" ></add>
            <add name="RowVersion" type="rowversion" length="8" search-type="none"/>
            <add name="SupplierID" type="int" primary-key="true"/>
          </fields>
        </add>

        <add name="Categories" version="RowVersion" prefix="Categories">
          <fields>
            <add name="CategoryID" type="int" primary-key="true"/>
            <add name="CategoryName" length="15"/>
            <add name="Description" length="MAX"/>
            <add name="Picture" type="byte[]" length="MAX" search-type="none"/>
            <add name="RowVersion" type="rowversion" length="8" search-type="none"/>
          </fields>
        </add>

        <add name="Shippers" version="RowVersion" prefix="Shippers">
          <fields>
            <add name="CompanyName" length="40"/>
            <add name="Phone" length="24"/>
            <add name="RowVersion" type="rowversion" length="8"/>
            <add name="ShipperID" type="int" primary-key="true"/>
          </fields>
        </add>

      </entities>

      <relationships>
        <add left-entity="Order Details" left-field="OrderID" right-entity="Orders" right-field="OrderID" />
        <add left-entity="Orders" left-field="CustomerID" right-entity="Customers" right-field="CustomerID" />
        <add left-entity="Orders" left-field="EmployeeID" right-entity="Employees" right-field="EmployeeID" />
        <add left-entity="Order Details" left-field="ProductID" right-entity="Products" right-field="ProductID" />
        <add left-entity="Products" left-field="SupplierID" right-entity="Suppliers" right-field="SupplierID" />
        <add left-entity="Products" left-field="CategoryID" right-entity="Categories" right-field="CategoryID" />
        <add left-entity="Orders" left-field="ShipVia" right-entity="Shippers" right-field="ShipperID" />
      </relationships>

      <calculated-fields>
        <add name="CountryExchange" length="128">
          <transforms>
            <add method="format" format="{0} to {1}">
              <parameters>
                <add field="SuppliersCountry"></add>
                <add field="OrdersShipCountry"></add>
              </parameters>
            </add>
          </transforms>
        </add>
      </calculated-fields>

      <maps>
        <add name="Managers" connection="input" query="select EmployeeID, FirstName + ' ' + LastName FROM Employees;" />
      </maps>

    </add>    
    
  </processes>
</transformalize>
